<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create Person</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 2rem; }
      form { max-width: 480px; }
      label { display:block; margin-top: 0.5rem; }
      input[type=text], input[type=email] { width:100%; padding:0.5rem; }
      .success { background:#e6ffed; border:1px solid #8ee0a6; padding:1rem; margin-bottom:1rem; }
    </style>
  </head>
  <body>
    <h1>Create Person</h1>

    {% if success %}
    <div class="success">
      Person saved! {% if person %}ID: {{ person.id }} — {{ person.first_name }} {{ person.last_name }} ({{ person.email }}){% endif %}
    </div>
    {% endif %}

    <div id="createSection">
      <label for="first_name">First name</label>
      <input id="first_name" name="first_name" type="text" required>

      <label for="last_name">Last name</label>
      <input id="last_name" name="last_name" type="text" required>

      <label for="email">Email</label>
      <input id="email" name="email" type="email" required>

      <div style="margin-top:1rem">
        <button id="saveBtn">Save (send JSON)</button>
      </div>

      <div id="createResult" style="margin-top:1rem"></div>
    </div>

    <hr style="margin:2rem 0">

    <h2>Lookup person by ID</h2>
    <p>Enter a person ID and click Lookup to open the person's page.</p>
    <form id="lookupForm">
      <label for="person_id">Person ID</label>
      <input id="person_id" name="person_id" type="number" min="1" required>
      <div style="margin-top:1rem">
        <button type="submit">Lookup</button>
      </div>
    </form>

    <script>
      // Redirect to the person detail endpoint using the entered ID.
      document.getElementById('lookupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('person_id').value;
        if (!id) return;
        window.location.href = '/persons/' + encodeURIComponent(id);
      });

      // Send JSON to the /persons/new endpoint and show result
      document.getElementById('saveBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        const first_name = document.getElementById('first_name').value;
        const last_name = document.getElementById('last_name').value;
        const email = document.getElementById('email').value;

        // basic client-side validation
        if (!first_name || !last_name || !email) {
          const r = document.getElementById('createResult');
          r.innerHTML = '<div style="color:#b33">Please fill out all fields.</div>';
          return;
        }

        try {
          const resp = await fetch('/persons/new', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ first_name, last_name, email })
          });

          const r = document.getElementById('createResult');
          if (!resp.ok) {
            let text = await resp.text();
            try { text = JSON.parse(text); } catch(_) {}
            r.innerHTML = '<div style="color:#b33">Error saving person: ' + (resp.status + ' ' + JSON.stringify(text)) + '</div>';
            return;
          }

          const person = await resp.json();
          r.innerHTML = '<div class="success">Person saved! ID: ' + person.id + ' — ' + person.first_name + ' ' + person.last_name + ' (' + person.email + ')</div>';

          // Optionally clear fields
          document.getElementById('first_name').value = '';
          document.getElementById('last_name').value = '';
          document.getElementById('email').value = '';
        } catch (err) {
          const r = document.getElementById('createResult');
          r.innerHTML = '<div style="color:#b33">Network error: ' + err + '</div>';
        }
      });
    </script>

  </body>
</html>
